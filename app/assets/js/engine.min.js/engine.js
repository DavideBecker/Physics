"use strict";function guid(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()}function Properties(){var e=this,i={};e.set=function(e,t){i[e]=t},e.get=function(e){return i[e]}}function KeyboardInput(){var e=this;e._pressed={},e.keyPressed=function(i){e._pressed[i.keyCode]=!0},e.keyReleased=function(i){e._pressed[i.keyCode]=!1},e.isPressed=function(i){return!!e._pressed[i]}}function ControllerInput(e){var i=this;i._pressed={},i.gpe=e()}function InputHandler(){this.devices={keyboard:new KeyboardInput,controller:{}}}function Position(e,i){this.x=e||0,this.y=i||0}function Size(e,i){this.width=e||0,this.height=i||0,this.updateCenter=function(){this.center=new Position(this.width/2,this.height/2)},this.updateCenter()}function Velocity(e,i){this.x=e||0,this.y=i||0}function Acceleration(e,i){this.x=e||0,this.y=i||0}function Gravity(e,i){this.x=e||config.GRAVITY_X,this.y=i||config.GRAVITY_Y}function DimensionWrapper(e,i,t,n,s){this.position=new Position(e.x,e.y),this.size=new Size(i.width,i.height),this.velocity=new Velocity(t.x,t.y),this.acceleration=new Acceleration(n.x,n.y),this.gravity=new Gravity(s.x,s.y),this.getTop=function(){return this.position.y},this.getLeft=function(){return this.position.x},this.getBottom=function(){return this.position.y+this.size.height},this.getRight=function(){return this.position.x+this.size.width},this.getMidX=function(){return this.position.x+this.size.center.x},this.getMidY=function(){return this.position.y+this.size.center.y}}function Shapes(){function e(e){e.getMidX(),e.getMidY();noStroke(),fill("#33A6AA"),text("ID: "+e.id+"\nCollides with: "+Object.keys(e.collidesWith)+"\nShape: "+e.properties.get("shape")+"\nType: "+e.properties.get("type")+"\nPos: x-"+e.position.x.toFixed(2)+" | "+e.position.y.toFixed(2)+"\nAcc: "+e.acceleration.x.toFixed(2)+" | "+e.acceleration.y.toFixed(2)+"\nVel: "+e.velocity.x.toFixed(2)+" | "+e.velocity.y.toFixed(2),e.position.x-game.renderOffset.x,e.position.y+game.renderOffset.y+e.size.height+14);for(var i in e.collidesWith){var t=e.collidesWith[i];stroke("#8C3EB5"),line(e.getMidX()-game.renderOffset.x,e.getMidY()+game.renderOffset.y,t.getMidX()-game.renderOffset.x,t.getMidY()+game.renderOffset.y)}}var i={box:function(e){var i=e.position.x,t=e.position.y;noStroke(),fill(55,189,255),rect(i-game.renderOffset.x,t+game.renderOffset.y,e.size.width,e.size.height)}},t={box:function(e){var i=e.position.x-game.renderOffset.x,t=e.position.y+game.renderOffset.y,n=e.getMidX()-game.renderOffset.x,s=e.getMidY()+game.renderOffset.y;noStroke(),fill("#333"),rect(i,t,e.size.width,e.size.height),stroke(70,255,33),strokeWeight(2),line(n,s,n+5*e.velocity.x,s+5*e.velocity.y),stroke("#00A0E12"),line(n,s,n+25*e.acceleration.x,s+25*e.acceleration.y),stroke("#D42322"),line(n,s,n+e.velocity.x-5*e.acceleration.x,s+e.velocity.y-5*e.acceleration.y)}};this.render=function(e){i[e.properties.get("shape")](e)},this.renderPhysicsOf=function(e){t[e.properties.get("shape")](e)},this.renderDebugOf=function(i){e(i)}}function Collider(){var e={box2box:function(e,i){var t=e.getTop(),n=e.getLeft(),s=e.getBottom(),r=e.getRight(),o=i.getTop(),a=i.getLeft(),c=i.getBottom(),d=i.getRight();return(!e.isStatic||!i.isStatic)&&(!(s<o||t>c||r<a||n>d)&&(e.collidesWith[i.id]=i,i.collidesWith[e.id]=e,!0))}};this.isColliding=function(i,t){if(i.id===t.id)return!1;var n=[i,t];return i.properties.get("shape")>t.properties.get("shape")&&(n=[t,i]),e[n[0].properties.get("shape")+"2"+n[1].properties.get("shape")](i,t)}}function Resolver(){var e={boxandbox:function(e,i){var t=i.getTop()+game.renderOffset.y,n=i.getLeft()-game.renderOffset.x,s=i.getRight()-game.renderOffset.x,r=i.getBottom()+game.renderOffset.y;fill(0);var o=.5*(e.size.width+i.size.width),a=.5*(e.size.height+i.size.height),c=e.getMidX()-i.getMidX(),d=e.getMidY()-i.getMidY();if(Math.abs(c)<=o&&Math.abs(d)<=a){var h=o*d,p=a*c;noStroke(),h>p?h>-p?(e.position.y=i.getBottom(),e.velocity.y=0,fill(0,0,255),game.showPhysics&&rect(n,r,i.size.width,5)):(e.position.x=i.getLeft()-e.size.width,e.velocity.x=0,fill(255,255,0),game.showPhysics&&rect(n-5,t,5,i.size.height)):h>-p?(e.position.x=i.getRight(),e.velocity.x=0,fill(255,0,0),game.showPhysics&&rect(s,t,5,i.size.height)):(e.position.y=i.getTop()-e.size.height,e.velocity.y=0,game.showPhysics&&(fill(0,255,0),rect(n,t-5,i.size.width,5)))}}};this.resolve=function(i,t){if(i.id===t.id)return!1;var n=[i,t];return i.properties.get("shape")>t.properties.get("shape")&&(n=[t,i]),e[n[0].properties.get("shape")+"and"+n[1].properties.get("shape")](i,t)}}function Core(){var e=this;e.showPhysics=!1,e.entities={},e.cameras={},e.activeCamera={},e.maps={},e.animations=[],e.renderOffset=new Position,e.resolver=new Resolver,e.collider=new Collider,e.shapes=new Shapes,e.timing={prev:(new Date).getTime(),curr:null},e.generateUniqueId=function(i,t){var n=guid();t[n]?e.generateUniqueId(i,t):(i.id=guid(),t[n]=i)},e.detectCollisions=function(){var i={};for(var t in e.entities){var n=e.entities[t];if(i[n.id]=!0,n.isVisible)for(var s in e.entities){var r=e.entities[s];!i[r.id]&&r.isVisible&&(delete n.collidesWith[r.id],delete r.collidesWith[n.id],e.collider.isColliding(n,r)&&e.resolver.resolve(n,r))}}},e.positions={update:function(i){var t,n=e.entities;for(var s in n)t=n[s],t.isVisible&&!t.isStatic&&(t.velocity.x+=t.acceleration.x,t.velocity.x=lerp(t.velocity.x,0,config.GRAVITY_X),t.velocity.y+=t.acceleration.y+t.gravity.y,t.position.x+=t.velocity.x*i,t.position.y+=t.velocity.y*i,t.pos=new Position(50,50),t.properties.get("fixed")||(t.pos.x+=e.renderOffset.x,t.pos.y+=e.renderOffset.y))}},e.render={entities:function(){for(var i in e.entities){var t=e.entities[i];t.isVisible&&(e.shapes.render(t),e.showPhysics&&e.shapes.renderPhysicsOf(t))}if(e.showPhysics)for(var n in e.entities){var s=e.entities[n];s.isVisible&&e.shapes.renderDebugOf(s)}},maps:function(){for(var i in e.maps){var t=e.maps[i];t.renderMap()}},animations:function(){for(var i in e.animations)e.animations[i].animate()},all:function(){e.render.maps(),e.render.entities(),e.render.animations()}},e.tick=function(){e.timing.curr=(new Date).getTime();var i=e.timing.curr-e.timing.prev;isActive&&(e.positions.update(i/20),e.detectCollisions()),e.activeCamera.render(),e.render.all(),e.timing.prev=e.timing.curr}}function Camera(e){var i=this;i.tracking=e||!1,i.position=new Position,i.offset=new Position,i.scrollX=!0,i.scrollY=!1;var t=new Position;i.setAsActiveCamera=function(){game.activeCamera=i},i.track=function(e){i.tracking=e},i.update=function(){i.position=i.tracking.position,i.scrollX?t.x=i.position.x+i.offset.x:t.x=i.offset.x,i.scrollY?t.y=i.position.y+i.offset.y:t.y=i.offset.y},i.render=function(){i.tracking&&i.update(),game.activeCamera.id===i.id&&(game.renderOffset.x=t.x,game.renderOffset.y=t.y)},game.generateUniqueId(i,game.cameras)}function PhysicsEntity(e,i,t,n){DimensionWrapper.apply(this,[new Position(e,i),new Size(t,n),new Velocity,new Acceleration,new Gravity]),this.restitution=.3,this.isStatic=!1,this.isVisible=!0}function GameEntity(e,i,t,n,s){PhysicsEntity.apply(this,arguments),this.properties=new Properties,this.collidesWith={};var r=!1;return!!shapes[s]&&(r=shapes[s],this.properties.set("shape",r),this.properties.set("type","entity"),this.properties.set("layer",1e3),this.destroy=function(){game.entities.splice(this.id,1)},void game.generateUniqueId(this,game.entities))}function Box(e,i,t,n){var s=shapes.box;GameEntity.apply(this,[e,i,t,n,s])}function Map(){var e=this;e.mapMatrix=[[]],e.tiles=[],e.tileSize=50,e.getTileAt=function(e,i){return mapMatrix[i][e]},e.setTileAt=function(i,t,n){var s=n.maps[e.id]||n;e.mapMatrix[t][i]=s},e.renderMap=function(){for(var i in e.mapMatrix)for(var t in e.mapMatrix){var n=e.mapMatrix[t][i];n&&(fill(100),rect(t*e.tileSize-game.renderOffset.x,i*e.tileSize+game.renderOffset.y,e.tileSize,e.tileSize))}},e.addTileToMap=function(i){return e.tiles.push(i)-1},game.generateUniqueId(e,game.maps)}function Tile(e){var i=this;i.maps={},i.addToMap=function(e){i.maps[e.id]=e.addTileToMap(i)},e&&i.addToMap(e)}function KeySpline(e){function i(e,i){return 1-3*i+3*e}function t(e,i){return 3*i-6*e}function n(e){return 3*e}function s(e,s,r){return((i(s,r)*e+t(s,r))*e+n(s))*e}function r(e,s,r){return 3*i(s,r)*e*e+2*t(s,r)*e+n(s)}function o(e){for(var i=e,t=0;t<4;++t){var n=r(i,a,d);if(0==n)return i;var o=s(i,a,d)-e;i-=o/n}return i}var a=e[0],c=e[1],d=e[2],h=e[3];this.get=function(e){return a==c&&d==h?e:s(o(e),c,h)}}function Animation(e,i,t){var n={ease:[.25,.1,.25,1],linear:[0,0,1,1],"ease-in":[.42,0,1,1],"ease-out":[0,0,.58,1],"ease-in-out":[.42,0,.58,1]};this.duration=i||500,this.easing=n[t]||n.ease,this.spline=new KeySpline(this.easing),this.frame=1,this.frameDuration=this.duration/1e3*config.FPS,this.progress=0,this.isRunning=!1,this.isLooping=!1;var s=1;this.start=(new Date).getTime(),this.animate=function(){this.progress=this.frame/this.frameDuration,this.progress<=0&&(s=1),this.isLooping&&(this.progress*=2),this.isRunning&&(this.progress<=1?(e(this.spline.get(this.progress)),this.frame+=s):this.isLooping?(e(this.spline.get(this.progress)),s=-1,this.frame+=s,this.progress>=2&&(this.frame=1)):e(this.spline.get(1)))},game.animations.push(this)}var input=new InputHandler;window.onload=function(){document.addEventListener("keydown",input.devices.keyboard.keyPressed,!1),document.addEventListener("keyup",input.devices.keyboard.keyReleased,!1),document.addEventListener("gamepadconnected",function(e){console.info("New gamepad with ID #"+e.gamepad.id+" connected"),input.devices.gamepads[e.gamepad.id]=new ControllerInput(e.gamepad)}),document.addEventListener("gamepaddisconnected",function(e){console.info("Gamepad #"+e.gamepad.id+" disconnected"),delete input.devices.gamepads[e.gamepad.id]})};var config={STICKY_THRESHOLD:.001,GRAVITY_X:.5,GRAVITY_Y:.5,FPS:60},keys={W:87,A:65,S:83,D:68,SPACE:32,ENTER:13,ESCAPE:27,SHIFT:16,CTRL:17,ALT:18,UP:38,DOWN:40,LEFT:37,RIGHT:39},shapes={box:"box"},isActive=!0;window.onfocus=function(){isActive=!0,input.devices.keyboard._pressed={}},window.onblur=function(){isActive=!1};var game=new Core;game.activeCamera=new Camera;